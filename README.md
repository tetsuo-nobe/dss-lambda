# Developing Serverless Solutions on AWS における AWS Lambda ワーク


## 準備

* インストラクターが指定した環境で AWS マネジメントコンソールにサインインして下さい。
    - このワークの環境は、ワークを実施する時間帯のみ使用可能です。
    - ワークに関連する操作のみ実施して下さいますようお願い致します。
* AWS マネジメントコンソールで、リージョンを **バージニア北部 (us-east-1)** を選択した状態にしてください。
* ご自分に割り当てられた 2桁の番号を覚えておいてください。

---
## 1. AWS SAM を使用してワークで使用する Lambda 関数や API Gateway の REST API を作成

1. マネージメントコンソール上部で **CloudShell** のアイコンを選択します。
    - ![cloudshell](images/cloudshell.png)
    - マネージメントコンソールの下部に CloudShell が表示されます。

1. CloudShell で下記のコマンドを実行し、AWS SAM プロジェクトを取得します。
    ```
    git clone https://github.com/tetsuo-nobe/dss-lambda
    ```

1. AWS SAM のプロジェクトフォルダに移動します。
    ```
    cd dss-lambda
    ```

1. AWS SAM のビルドを行います。
    ```
    sam build 
    ```

1. AWS SAM のデプロイを行います。
    ```
    sam deploy --guided
    ```
    - スタック名に `dss-lambda-<自分の番号>` を入力します。
    - 対話形式の入力では、すべてデフォルトのまま Enter キーを押下します。

1. デプロイ完了後に表示される **DemoAPI** の URL の値をメモしておきます。
    -  ブラウザでこの URL にアクセスして、背景色が青のページが表示されることを確認します。

1. CloudShell の右上の X を選択して閉じます。
---
## 2. Lambda 関数のバージョンとエイリアス 

1. マネジメントコンソールで AWS Lambda のコンソールを表示し、**demo-function-dss-lambda-<自分の番号>** の関数を開きます。

1. **コード** タブのコードで、14行目と 15行目の `blue` を `green` に変更します。

1. ページ左側にある **Deploy**　を選択します。

1. **バージョン** タブを選択します。

1. **Publish new version** を選択します。

1. **Version description - オプション** に `green` と入力して **Publish** を選択します。

1. ページ上部にあるブレッドクラムで **demo-function-dss-lambda-<自分の番号>** を選択します。

1. **エイリアス** タブを選択します。

1. エイリアス **live** の左隣のラジオボタンを選択して、**編集** を選択します。

1. **Weighted alias** を展開表示します。

1. **Additional version - オプション** で最新のバージョンを選択して、**Weight** に **50** を指定します。

1. **保存** を選択します。

1. DemoAPI の URL に複数回アクセスします。
    - 青色のページと緑色のページが、おおよそ 50% の比率で表示されることを確認します。

1. 再びエイリアス live を編集して最新バージョンの**Weight** に **100** を指定します。

1. **保存** を選択します。

1. DemoAPI の URL に複数回アクセスします。
    - 緑色のページのみ表示されることを確認します。

---
## 3. Lambda 関数の「予約された同時実行数」

1. マネジメントコンソールで AWS Lambda のコンソールを表示し、**demo-function-dss-lambda-<自分の番号>** の関数を開きます。

1. **設定** タブを選択します。

1. **同時実行と再帰の検出** を選択します。

1. **同時実行**　で **編集** を選択します。

1. **同時実行の予約** を選択して、`0` を入力し、**保存** を選択します。
    -  この設定により、Lambda 関数はスロットリング状態になります。

1. **テスト** タブを選択します。

1. **テスト** を選択します。
    - エラーメッセージで **Rate Exceeded** が表示されることを確認します。

1. **設定** タブを選択します。

1. **同時実行と再帰の検出** を選択します。

1. **同時実行**　で **編集** を選択します。

1. **予約されていないアカウントの同時実行の使用** を選択して、**保存** を選択します。
    -  この設定により、Lambda 関数はスロットリングされていない状態になります。


---
## 4. 実行環境の再利用

1. マネジメントコンソールで AWS Lambda のコンソールを表示し、**demo-function-dss-lambda-<自分の番号>** の関数を開きます。

1. **コードソース** のコードの 5行目の先頭の # を削除します。
    - これにより、コールドスタート時に この Lambda 関数 の実行に約3秒かかるようになります。 

1. ページ左側にある **Deploy**　を選択します。

1. **バージョン** タブを選択します。

---
## 5. Lambda 関数の SnapStart

1. **コード** タブを選択して、ページ下部の **ランタイム設定** の **編集** を選択します。

1. **ランタイム** を **Python3.13** に変更して **保存** を選択します。

1. **コードソース** のコードの 5行目の先頭の # を削除します。
    - これにより、コールドスタート時に この Lambda 関数 の実行に約3秒かかるようになります。 

1. ページ左側にある **Deploy**　を選択します。

1. **テスト** タブを選択し、**テスト** を選択します。
    - 関数のコードを変更した後の初回実行なので、コールドスタートとなり、実行に約3秒かかることを確認します。
    - この関数に **SnapStart** を適用し、コールドスタートの実行時間を改善します。

1. **コード** タブを選択して、14行目と 15行目の `green` を `red` に変更します。

1. ページ左側にある **Deploy**　を選択します。

1. **設定** タブを選択します。

1. **一般設定** を選択します。

1. **一般設定**　で **編集** を選択します。

1. **SnapStart** で **PublishedVersions** を選択して、**保存** を選択します。

1. **バージョン** タブを選択します。

1. **Publish new version** を選択します。

1. **Version description - オプション** に `red` と入力して **Publish** を選択します。
    - SnapStart によりスナップショットの作成が完了するまで少し待ちます。

1. **テスト** タブを選択し、**テスト** を選択します。
    - 関数のコードを変更してバージョンを発行した後の初回実行なので、通常ならコールドスタートとなりますが、SnapStart を適用しているので3秒よりは短い時間で実行されることを確認して下さい。
    - 初回のテスト実行後、**実行中の関数: 成功** の **詳細**　を展開表示し、**復元時間** を確認します。

---
## 3. 使用したリソースの削除

1. マネージメントコンソール上部で **CloudShell** のアイコンを選択します。
    - マネージメントコンソールの下部に CloudShell が表示されます。

1. カレントフォルダが AWS SAM のプロジェクトフォルダ (dss-lambda) でなければ下記を実行します。
    ```
    cd /home/cloudshell-user/dss-lambda
    ```

1. AWS SAM のリソースを削除します。
    ```
    sam delete --no-prompts
    ```

---
## お疲れさまでした。

* **このワークの環境は、ワークを実施する時間帯のみ使用可能です。**
